<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizUp+ ‚Äì Boost Your Knowledge</title>
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#FF6B4A" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
          colors: {
            primary: {50:'#FFF5F2',100:'#FFE8E0',200:'#FFD1C1',300:'#FFB5A0',400:'#FF8D75',500:'#FF6B4A',600:'#E84A28',700:'#C23818',800:'#9D2A0F',900:'#7A1F08'},
            secondary: {50:'#F0F7F9',100:'#D9EDF2',200:'#B3DBE5',300:'#8DC9D8',400:'#67B5CB',500:'#4A90A4',600:'#3A7383',700:'#2B5662',800:'#1D3A42',900:'#0F1F24'},
            accent: {50:'#F0FDFB',100:'#CCFBF1',200:'#99F6E4',300:'#5EDFD1',400:'#5EC5B6',500:'#3DA89C',600:'#2D8A7F',700:'#1F6B63',800:'#134E49',900:'#0A3330'},
            dark: {50:'#E8EAED',100:'#D1D5DA',200:'#A3ABB5',300:'#758190',400:'#47576B',500:'#1A2332',600:'#151C28',700:'#10151E',800:'#0B0E14',900:'#06070A'}
          },
          boxShadow: { 
            card: '0 4px 16px rgba(0,0,0,0.08)', 
            pill: '0 8px 24px rgba(255,107,74,0.25)',
            glow: '0 0 20px rgba(255,107,74,0.3)'
          },
          borderRadius: { xl2: '16px', xl3: '20px' },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in',
            'slide-up': 'slideUp 0.4s ease-out',
            'bounce-soft': 'bounceSoft 0.6s ease-in-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            bounceSoft: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body class="min-h-screen text-dark-900">
  <div id="toast-container" class="toast-container"></div>
  <div id="root"></div>

  <!-- Firebase Config & Init -->
  <script src="config/runtime-env.js"></script>
  <script src="config/firebase-config.js"></script>
  <script>
    if (!window.__FIREBASE_CONFIG) {
      console.error('Firebase yapƒ±landƒ±rmasƒ± eksik. `config/firebase-config.sample.js` dosyasƒ±nƒ± `config/firebase-config.js` olarak kopyalayƒ±n.');
    }
  </script>
  <script type="module" src="utils/firebase.js"></script>
  
  <!-- Utils & Helpers -->
  <script type="text/babel" src="utils/helpers.js"></script>
  <script type="text/babel" src="utils/hooks.js"></script>
  <script src="utils/location.js"></script>
  
  <!-- Components - CRITICAL: Load sub-components BEFORE parent components -->
  <script type="text/babel" src="components/Sidebar.jsx"></script>
  <script type="text/babel" src="components/Landing.jsx"></script>
  <script type="text/babel" src="components/Login.jsx"></script>
  <script type="text/babel" src="components/UserManagement.jsx"></script>
  <script type="text/babel" src="components/SuggestQuestion.jsx"></script>
  <script type="text/babel" src="components/SuggestedQuestions.jsx"></script>
  <script type="text/babel" src="components/MyTests.jsx"></script>
  <script type="text/babel" src="components/Manager.jsx"></script>
  <script type="text/babel" src="components/Quiz.jsx"></script>
  <script type="text/babel" src="components/Dashboard.jsx"></script>
  <script type="text/babel" src="components/Tests.jsx"></script>
  <script type="text/babel" src="components/Result.jsx"></script>
  <script type="text/babel" src="components/Branding.jsx"></script>
  <script type="text/babel" src="components/LocationMap.jsx"></script>
  
  <!-- Admin components - QuestionList and AdminForm MUST load before Admin -->
  <script type="text/babel">
    // QuestionList Component
    const QuestionList = ({ questions, handleEdit, handleDelete, toggleActive, setShowForm }) => {
      const { useState, useEffect, useRef } = React;
      const [showFilters, setShowFilters] = useState(false);
      const [filters, setFilters] = useState({
        categories: [],
        difficulties: [],
        status: [] // 'active', 'inactive'
      });
      const filterRef = useRef(null);

      // Close dropdown when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (filterRef.current && !filterRef.current.contains(e.target)) {
            setShowFilters(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      // Get unique categories from questions
      const uniqueCategories = [...new Set(questions.map(q => q.category).filter(Boolean))].sort();
      const difficulties = [
        { value: 'easy', label: 'Kolay' },
        { value: 'medium', label: 'Orta' },
        { value: 'hard', label: 'Zor' }
      ];

      // Toggle filter selection
      const toggleFilter = (type, value) => {
        setFilters(prev => ({
          ...prev,
          [type]: prev[type].includes(value)
            ? prev[type].filter(v => v !== value)
            : [...prev[type], value]
        }));
      };

      // Clear all filters
      const clearFilters = () => {
        setFilters({ categories: [], difficulties: [], status: [] });
      };

      // Apply filters to questions
      const filteredQuestions = questions.filter(q => {
        // Category filter
        if (filters.categories.length > 0 && !filters.categories.includes(q.category)) {
          return false;
        }
        // Difficulty filter
        if (filters.difficulties.length > 0 && !filters.difficulties.includes(q.difficulty)) {
          return false;
        }
        // Status filter
        if (filters.status.length > 0) {
          if (filters.status.includes('active') && !q.isActive) return false;
          if (filters.status.includes('inactive') && q.isActive) return false;
          if (filters.status.length === 2) return true; // Both selected = show all
        }
        return true;
      });

      // Count active filters
      const activeFilterCount = filters.categories.length + filters.difficulties.length + filters.status.length;

      if (questions.length === 0) {
        return (
          <div className="card p-12 text-center">
            <div className="text-6xl mb-4">üìù</div>
            <p className="text-dark-500 text-lg">Hen√ºz soru eklenmemi≈ü</p>
            <button className="btn btn-primary mt-4" onClick={() => setShowForm(true)}>ƒ∞lk Soruyu Ekle</button>
          </div>
        );
      }

      return (
        <div className="grid gap-4">
          {/* Filter Section */}
          <div className="flex justify-between items-center mb-2">
            <div className="text-sm text-dark-600">
              {filteredQuestions.length} / {questions.length} soru g√∂steriliyor
            </div>

            <div className="relative" ref={filterRef}>
              <button
                className="btn btn-secondary flex items-center gap-2"
                onClick={() => setShowFilters(!showFilters)}
              >
                üîç Filtrele
                {activeFilterCount > 0 && (
                  <span className="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary-500 rounded-full">
                    {activeFilterCount}
                  </span>
                )}
              </button>

              {/* Filter Dropdown */}
              {showFilters && (
                <div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50 p-4" style={{ animation: 'fadeIn 0.2s ease-in' }}>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-dark-900">Filtreler</h3>
                    {activeFilterCount > 0 && (
                      <button
                        className="text-xs text-primary-500 hover:text-primary-600 font-semibold"
                        onClick={clearFilters}
                      >
                        T√ºm√ºn√º Temizle
                      </button>
                    )}
                  </div>

                  {/* Category Filter */}
                  {uniqueCategories.length > 0 && (
                    <div className="mb-4">
                      <h4 className="text-sm font-semibold text-dark-700 mb-2">üìÅ Kategori</h4>
                      <div className="space-y-2 max-h-40 overflow-y-auto">
                        {uniqueCategories.map(cat => (
                          <label key={cat} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                            <input
                              type="checkbox"
                              checked={filters.categories.includes(cat)}
                              onChange={() => toggleFilter('categories', cat)}
                              className="w-4 h-4 text-primary-500 rounded"
                            />
                            <span className="text-sm text-dark-800">{cat}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Difficulty Filter */}
                  <div className="mb-4">
                    <h4 className="text-sm font-semibold text-dark-700 mb-2">‚ö° Zorluk</h4>
                    <div className="space-y-2">
                      {difficulties.map(diff => (
                        <label key={diff.value} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                          <input
                            type="checkbox"
                            checked={filters.difficulties.includes(diff.value)}
                            onChange={() => toggleFilter('difficulties', diff.value)}
                            className="w-4 h-4 text-primary-500 rounded"
                          />
                          <span className="text-sm text-dark-800">{diff.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  {/* Status Filter */}
                  <div>
                    <h4 className="text-sm font-semibold text-dark-700 mb-2">üìä Durum</h4>
                    <div className="space-y-2">
                      <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                        <input
                          type="checkbox"
                          checked={filters.status.includes('active')}
                          onChange={() => toggleFilter('status', 'active')}
                          className="w-4 h-4 text-primary-500 rounded"
                        />
                        <span className="text-sm text-dark-800">Aktif</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                        <input
                          type="checkbox"
                          checked={filters.status.includes('inactive')}
                          onChange={() => toggleFilter('status', 'inactive')}
                          className="w-4 h-4 text-primary-500 rounded"
                        />
                        <span className="text-sm text-dark-800">Pasif</span>
                      </label>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Questions List */}
          {filteredQuestions.length === 0 ? (
            <div className="card p-12 text-center">
              <div className="text-6xl mb-4">üîç</div>
              <p className="text-dark-500 text-lg">Filtreye uygun soru bulunamadƒ±</p>
              <button
                className="btn btn-secondary mt-4"
                onClick={clearFilters}
              >
                Filtreleri Temizle
              </button>
            </div>
          ) : (
            filteredQuestions.map(q => (
            <div key={q.id} className="card p-6">
              <div className="flex flex-col lg:flex-row justify-between items-start gap-4">
                <div className="flex-1 min-w-0 w-full">
                  <div className="flex items-center gap-3 mb-2 flex-wrap">
                    <span className="chip chip-blue">{typeLabel(q.type)}</span>
                    <span className="chip chip-orange">{q.category}</span>
                    <span className="chip bg-gray-200 text-gray-600">
                      {q.difficulty === 'easy' ? 'Kolay' : q.difficulty === 'medium' ? 'Orta' : 'Zor'}
                    </span>
                  </div>
                  <p className="font-semibold text-lg text-dark-900 mb-2 break-words">{q.questionText}</p>
                  {q.type === 'mcq' && q.options && (
                    <div className="text-sm text-dark-600 mt-2 break-words">
                      <b>Se√ßenekler:</b> {q.options.join(' ‚Ä¢ ')}
                      <br/><b>Doƒüru:</b> <span className="text-accent-600 font-semibold break-words">{q.correctAnswer}</span>
                    </div>
                  )}
                  <div className="text-xs text-dark-400 mt-2">
                    Olu≈üturulma: {fmtDate(q.createdAt)}
                  </div>
                </div>
                <div className="flex items-center gap-4 flex-shrink-0">
                  <div className="flex flex-col items-center gap-1">
                    <label className="toggle-switch">
                      <input type="checkbox" checked={q.isActive} onChange={() => toggleActive(q.id, q.isActive)} />
                      <span className="toggle-slider"></span>
                    </label>
                    <span className="text-xs text-dark-500">{q.isActive ? 'Aktif' : 'Pasif'}</span>
                  </div>
                  <div className="flex gap-2">
                    <button className="btn btn-ghost text-sm px-3 py-2" onClick={() => handleEdit(q)}>‚úèÔ∏è D√ºzenle</button>
                    <button className="btn btn-danger text-sm px-3 py-2" onClick={() => handleDelete(q.id)}>üóëÔ∏è</button>
                  </div>
                </div>
              </div>
            </div>
            ))
          )}
        </div>
      );
    };

    window.QuestionList = QuestionList;
  </script>
  
  <script type="text/babel" src="components/AdminForm.jsx"></script>
  <script type="text/babel" src="components/Admin.jsx"></script>
  
  <!-- Main App -->
  <script type="text/babel">
    const { useEffect, useState } = React;

    const App = () => {
      useAnon();
      const route = useHash();
      const [authReady, setAuthReady] = useState(Boolean(window.__firebaseAuthReady));

      useEffect(() => {
        if (window.__firebaseAuthReady) {
          setAuthReady(true);
        }

        const handleAuth = (event) => {
          if (event?.detail?.ready) {
            setAuthReady(true);
          }
        };

        window.addEventListener('fb-auth-state', handleAuth);
        return () => window.removeEventListener('fb-auth-state', handleAuth);
      }, []);

      if (!authReady) {
        return (
          <main className="min-h-screen flex items-center justify-center bg-white">
            <LoadingSpinner text="Oturum doƒürulanƒ±yor..." />
          </main>
        );
      }

      return (
        <>
          <Sidebar />
          <main>
            {route === '/' || route === '' ? <Landing />
              : route.startsWith('/login') ? <Login />
              : route.startsWith('/users') ? (isLoggedIn() && hasRole('admin') ? <UserManagement /> : (() => { requireAuth('admin'); return null; })())
              : route.startsWith('/suggestions') ? (isLoggedIn() && hasRole('admin') ? <SuggestedQuestions /> : (() => { requireAuth('admin'); return null; })())
              : route.startsWith('/suggest') ? <SuggestQuestion />
              : route.startsWith('/mytests') ? <MyTests />
              : route.startsWith('/branding') ? (isLoggedIn() && hasRole('admin') ? <Branding /> : (() => { requireAuth('admin'); return null; })())
              : route.startsWith('/dashboard') ? (isLoggedIn() && hasRole(['admin', 'manager']) ? <Dashboard /> : (() => { requireAuth(['admin', 'manager']); return null; })())
              : route.startsWith('/quiz/') ? <Quiz sessionId={route.split('/')[2]} />
              : route.startsWith('/result') ? (() => {
                  const params = new URLSearchParams(route.split('?')[1] || '');
                  return <Result sessionId={params.get('sessionId')} resultId={params.get('resultId')} />
                })()
              : route.startsWith('/manager') ? (isLoggedIn() && hasRole(['admin', 'manager']) ? <Manager /> : (() => { requireAuth(['admin', 'manager']); return null; })())
              : route.startsWith('/tests') ? (isLoggedIn() ? <Tests /> : (() => { requireAuth(); return null; })())
              : route.startsWith('/admin') ? (isLoggedIn() && hasRole('admin') ? <Admin /> : (() => { requireAuth('admin'); return null; })())
              : <Landing />
            }
          </main>
        </>
      );
    };

    const renderApp = () => {
      if (!window.__appRoot) {
        window.__appRoot = ReactDOM.createRoot(document.getElementById('root'));
      }
      window.__appRoot.render(<App />);
    };

    if (window.__firebaseReadyPromise) {
      window.__firebaseReadyPromise.then(renderApp);
    } else if (window.firebase?.db) {
      renderApp();
    } else {
      window.addEventListener('fb-ready', renderApp, { once: true });
    }
  </script>
</body>
</html>
