rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isManagerOrAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'manager'];
    }

    // Null-safe company getter
    function getUserCompany() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('company', null)
        : null;
    }

    // Null-safe company comparison
    function isSameCompany(companyField) {
      let userComp = getUserCompany();
      return userComp != null && companyField != null && companyField == userComp;
    }

    // ğŸ”’ SECURITY: Prevent password field access
    function hasPasswordField(data) {
      return 'password' in data;
    }

    // ğŸ†• Check if user is owner of the result
    function isResultOwner(resultData) {
      return isSignedIn() && resultData.ownerUid == request.auth.uid;
    }

    // ğŸŒŸ Super Admin check
    function isSuperAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('isSuperAdmin', false) == true;
    }

    // ========================================
    // COMPANIES COLLECTION
    // ========================================
    match /companies/{companyId} {
      // SÃ¼per admin tÃ¼m ÅŸirketleri, admin sadece kendi ÅŸirketini gÃ¶rebilir
      allow read: if isSuperAdmin() ||
                     (isAdmin() && getUserCompany() == companyId);

      // Sadece sÃ¼per admin ÅŸirket oluÅŸturabilir
      allow create: if isSuperAdmin();

      // SÃ¼per admin tÃ¼m ÅŸirketleri, admin kendi ÅŸirketini gÃ¼ncelleyebilir
      allow update: if isSuperAdmin() ||
                       (isAdmin() && getUserCompany() == companyId);

      // Sadece sÃ¼per admin silebilir
      allow delete: if isSuperAdmin();
    }

    // ========================================
    // QUESTIONS COLLECTION
    // ========================================
    match /questions/{questionId} {
      // âœ… Quiz QR kod ile aÃ§Ä±labildiÄŸi iÃ§in read iÃ§in auth gerekmez
      allow read: if true;

      // âœ… Admin sadece kendi ÅŸirketinin sorularÄ±nÄ± oluÅŸturabilir
      allow create: if isAdmin() && isSameCompany(request.resource.data.company);

      // âœ… Admin sadece kendi ÅŸirketinin sorularÄ±nÄ± gÃ¼ncelleyebilir/silebilir
      allow update, delete: if isAdmin() && isSameCompany(resource.data.company);
    }

    // ========================================
    // SUGGESTED QUESTIONS COLLECTION
    // ========================================
    match /suggestedQuestions/{suggestionId} {
      // âœ… GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ÅŸirketinin Ã¶nerilerini gÃ¶rebilir
      allow read: if isSignedIn() && (
        isSameCompany(resource.data.company) ||
        resource.data.company == null // Backward compatibility
      );

      // âœ… Anonim kullanÄ±cÄ±lar da soru Ã¶nerebilir (quiz sÄ±rasÄ±nda)
      allow create: if request.resource.data.company != null;

      // âœ… Sadece admin kendi ÅŸirketinin Ã¶nerilerini gÃ¼ncelleyebilir/silebilir
      allow update, delete: if isAdmin() && isSameCompany(resource.data.company);
    }

    // ========================================
    // QUIZ SESSIONS COLLECTION
    // ========================================
    match /quizSessions/{sessionId} {
      // âœ… FIXED: QR kod ile herkes kendi session'Ä±na eriÅŸebilir
      // Ancak sadece kendi ÅŸirketinin session'larÄ±nÄ± listeleyebilir
      allow read: if true; // QR kod access iÃ§in gerekli

      // âœ… FIXED: Sadece manager/admin kendi ÅŸirketi iÃ§in session oluÅŸturabilir
      allow create: if isManagerOrAdmin() && isSameCompany(request.resource.data.company);

      // âœ… FIXED: Manager/admin sadece kendi ÅŸirketinin session'larÄ±nÄ± silebilir
      allow delete: if isManagerOrAdmin() && isSameCompany(resource.data.company);

      // âœ… FIXED: Quiz tamamlama iÃ§in kontrollÃ¼ gÃ¼ncelleme
      // Sadece status ve completion bilgileri gÃ¼ncellenebilir
      allow update: if true && (
        // Sadece belirli alanlar deÄŸiÅŸtirilebilir
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completedAt', 'completedBy', 'updatedAt'])
      );
    }

    // ========================================
    // RESULTS COLLECTION
    // ========================================
    match /results/{resultId} {
      // âœ… FIXED: Multi-tenant isolation - Sadece kendi ÅŸirketinin sonuÃ§larÄ±nÄ± gÃ¶rebilir
      // VEYA kendi oluÅŸturduÄŸu sonucu gÃ¶rebilir (anonim kullanÄ±cÄ±lar iÃ§in)
      allow read: if isSignedIn() && (
        isSameCompany(resource.data.company) ||
        isResultOwner(resource.data)
      );

      // âœ… FIXED: Result oluÅŸturma kontrolÃ¼
      allow create: if isSignedIn() &&
                      request.resource.data.ownerUid == request.auth.uid &&
                      // Session'dan company bilgisi alÄ±nmalÄ± (client'ta zaten yapÄ±lÄ±yor)
                      request.resource.data.company != null;

      // Result'lar gÃ¼ncellenemez
      allow update: if false;

      // âœ… FIXED: Sadece manager/admin kendi ÅŸirketinin sonuÃ§larÄ±nÄ± silebilir
      allow delete: if isManagerOrAdmin() && isSameCompany(resource.data.company);
    }

    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      // âœ… FIXED: Multi-tenant isolation
      // KullanÄ±cÄ±lar sadece kendi ÅŸirketlerindeki diÄŸer kullanÄ±cÄ±larÄ± gÃ¶rebilir
      // VEYA kendilerini gÃ¶rebilir
      // ğŸŒŸ Super admin tÃ¼m kullanÄ±cÄ±larÄ± gÃ¶rebilir
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isSameCompany(resource.data.company) ||
        request.auth.uid == userId
      );

      // KullanÄ±cÄ± oluÅŸturma:
      // - Super admin herhangi bir ÅŸirket iÃ§in kullanÄ±cÄ± oluÅŸturabilir
      // - Admin kendi ÅŸirketi iÃ§in kullanÄ±cÄ± oluÅŸturabilir
      // - Veya kendi dokÃ¼manÄ±nÄ± oluÅŸturabilir
      // ğŸ”’ SECURITY: password field asla yazÄ±lamaz
      allow create: if (
        isSuperAdmin() ||
        (isAdmin() && isSameCompany(request.resource.data.company)) ||
        (isSignedIn() && request.auth.uid == userId)
      ) && !hasPasswordField(request.resource.data);

      // KullanÄ±cÄ± gÃ¼ncelleme:
      // - Super admin herhangi bir kullanÄ±cÄ±yÄ± gÃ¼ncelleyebilir
      // - KullanÄ±cÄ± kendi bilgilerini gÃ¼ncelleyebilir (company hariÃ§)
      // - Veya admin kendi ÅŸirketinin kullanÄ±cÄ±larÄ±nÄ± gÃ¼ncelleyebilir
      // ğŸ”’ SECURITY: password field asla eklenemez veya gÃ¼ncellenemez
      allow update: if (
        isSuperAdmin() ||
        (isSignedIn() && request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'company', 'isSuperAdmin'])) ||
        (isAdmin() && isSameCompany(resource.data.company))
      ) && !hasPasswordField(request.resource.data);

      // âœ… FIXED: Super admin veya admin sadece kendi ÅŸirketinin kullanÄ±cÄ±larÄ±nÄ± silebilir
      allow delete: if isSuperAdmin() || (isAdmin() && isSameCompany(resource.data.company));
    }

    // ========================================
    // SETTINGS / BRANDING COLLECTIONS
    // ========================================
    match /settings/{docId} {
      allow read, write: if isAdmin();
    }

    match /branding/{company} {
      // âœ… FIXED: Sadece kendi ÅŸirketinin branding'ini gÃ¶rebilir
      allow read: if isSignedIn() && (
        company == getUserCompany() ||
        company == 'default' // Default branding herkes gÃ¶rebilir
      );

      // âœ… FIXED: Admin sadece kendi ÅŸirketinin branding'ini deÄŸiÅŸtirebilir
      allow write: if isAdmin() && company == getUserCompany();
    }

    // ========================================
    // QUESTION PACKAGES COLLECTION
    // ========================================
    match /questionPackages/{packageId} {
      // ğŸ“¦ TEST: GeÃ§ici olarak tÃ¼m giriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar okuyabilir
      allow read: if isSignedIn();

      // ğŸ“¦ Manager/Admin kendi ÅŸirketi iÃ§in paket oluÅŸturabilir
      allow create: if isManagerOrAdmin() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       isSameCompany(request.resource.data.company);

      // ğŸ“¦ Admin tÃ¼m paketleri, manager sadece kendi paketini gÃ¼ncelleyebilir/silebilir
      allow update, delete: if isManagerOrAdmin() && isSameCompany(resource.data.company) && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }
  }
}
